# the claude poking machine
# runs 3x daily to annoy claude into resetting quota

name: poke claude

on:
  schedule:
    # asia/shanghai times (UTC+8)
    # 09:00 CST = 01:00 UTC - morning poke
    # 14:00 CST = 06:00 UTC - afternoon poke
    # 19:00 CST = 11:00 UTC - evening poke
    - cron: "0 1,6,11 * * *"

  workflow_dispatch:
    inputs:
      victim:
        description: "who to poke"
        required: false
        default: "everyone"
        type: choice
        options:
          - everyone
          - max5x
          - pro
      dry_run:
        description: "pretend to poke (for testing)"
        required: false
        default: false
        type: boolean
      bark:
        description: "send bark notification"
        required: false
        default: true
        type: boolean

jobs:
  poke:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - victim: max5x
            name: "the fancy one"
            poke_style: "draw a tiny ascii art of a mass-effect style spaceship, max 5 lines. include pew pew"
          - victim: pro
            name: "the regular one"
            poke_style: "draw a tiny ascii cat stretching after a nap, max 4 lines"

    name: poking ${{ matrix.name }}

    steps:
      - name: should we poke this one?
        id: check
        run: |
          TARGET="${{ inputs.victim || 'everyone' }}"
          CURRENT="${{ matrix.victim }}"
          if [ "$TARGET" = "everyone" ] || [ "$TARGET" = "$CURRENT" ]; then
            echo "poke=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ $CURRENT is getting poked"
          else
            echo "poke=false" >> $GITHUB_OUTPUT
            echo "ðŸ˜´ $CURRENT gets to sleep"
          fi

      - name: poke poke poke
        id: poke
        if: steps.check.outputs.poke == 'true'
        uses: thevibeworks/claude-quota-scheduler@v1
        with:
          account_name: ${{ matrix.victim }}
          oauth_token: ${{ secrets[format('CLAUDE_OAUTH_{0}', matrix.victim)] }}
          timezone: "Asia/Shanghai"
          ping_prompt: ${{ matrix.poke_style }}
          dry_run: ${{ inputs.dry_run || 'false' }}
          summary_style: "ascii-art"

      - name: bark this one
        if: steps.check.outputs.poke == 'true' && (inputs.bark != false)
        env:
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
          BARK_DEVICES: ${{ secrets.BARK_DEVICES }}
          BARK_MSG: ${{ steps.poke.outputs.bark_message }}
          VICTIM: ${{ matrix.victim }}
          SUCCESS: ${{ steps.poke.outputs.success }}
        run: |
          if [ -z "$BARK_SERVER" ] || [ -z "$BARK_DEVICES" ]; then
            echo "no bark config, sad dog noises"
            exit 0
          fi

          NOW=$(TZ="Asia/Shanghai" date "+%H:%M")

          if [ "$SUCCESS" = "true" ]; then
            TITLE="$VICTIM @ $NOW"
          else
            TITLE="$VICTIM ded @ $NOW"
          fi

          # use claude's message, fallback if empty
          BODY="${BARK_MSG:-claude said something but idk what}"

          TITLE_ENC=$(printf '%s' "$TITLE" | jq -sRr @uri)
          BODY_ENC=$(printf '%s' "$BODY" | jq -sRr @uri)

          IFS=',' read -ra DEVICES <<< "$BARK_DEVICES"
          for device in "${DEVICES[@]}"; do
            device=$(echo "$device" | xargs)
            curl -s "${BARK_SERVER}/${device}/${TITLE_ENC}/${BODY_ENC}?group=quota&icon=https://claude.ai/favicon.ico" || true
          done

          echo "barked: $BODY"

  # each account barks for itself now with claude-generated messages
  # this job just shows overall status in the workflow UI
  status:
    needs: poke
    if: always()
    runs-on: ubuntu-latest
    name: "${{ needs.poke.result == 'success' && 'âœ“ all poked' || 'âœ— something failed' }}"
    steps:
      - run: |
          echo ""
          echo "  /\\_/\\"
          echo " ( o.o )  poke session complete"
          echo "  > ^ <"
          echo ""
          echo "result: ${{ needs.poke.result }}"
