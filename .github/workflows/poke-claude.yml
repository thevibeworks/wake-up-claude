# the claude poking machine
# runs 3x daily to annoy claude into resetting quota

name: poke claude

on:
  schedule:
    # asia/shanghai times (UTC+8)
    # 09:00 CST = 01:00 UTC - morning poke
    # 14:00 CST = 06:00 UTC - afternoon poke
    # 19:00 CST = 11:00 UTC - evening poke
    - cron: "0 1,6,11 * * *"

  workflow_dispatch:
    inputs:
      victim:
        description: "who to poke"
        required: false
        default: "everyone"
        type: choice
        options:
          - everyone
          - max5x
          - pro
      dry_run:
        description: "pretend to poke (for testing)"
        required: false
        default: false
        type: boolean
      bark:
        description: "send bark notification"
        required: false
        default: true
        type: boolean

jobs:
  poke:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - victim: max5x
            name: "the fancy one"
            poke_style: "draw a tiny ascii art of a mass-effect style spaceship, max 5 lines. include pew pew"
          - victim: pro
            name: "the regular one"
            poke_style: "draw a tiny ascii cat stretching after a nap, max 4 lines"

    name: poking ${{ matrix.name }}

    steps:
      - name: should we poke this one?
        id: check
        run: |
          TARGET="${{ inputs.victim || 'everyone' }}"
          CURRENT="${{ matrix.victim }}"
          if [ "$TARGET" = "everyone" ] || [ "$TARGET" = "$CURRENT" ]; then
            echo "poke=true" >> $GITHUB_OUTPUT
            echo "üéØ $CURRENT is getting poked"
          else
            echo "poke=false" >> $GITHUB_OUTPUT
            echo "üò¥ $CURRENT gets to sleep"
          fi

      - name: poke poke poke
        id: poke
        if: steps.check.outputs.poke == 'true'
        uses: thevibeworks/claude-quota-scheduler@v1
        with:
          account_name: ${{ matrix.victim }}
          oauth_token: ${{ secrets[format('CLAUDE_OAUTH_{0}', matrix.victim)] }}
          timezone: "Asia/Shanghai"
          ping_prompt: ${{ matrix.poke_style }}
          dry_run: ${{ inputs.dry_run || 'false' }}
          summary_style: "ascii-art"

  bark:
    needs: poke
    if: always() && (inputs.bark != false)
    runs-on: ubuntu-latest
    name: woof woof (bark notify)
    steps:
      - name: bark the results
        env:
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
          BARK_DEVICES: ${{ secrets.BARK_DEVICES }}
          POKE_RESULT: ${{ needs.poke.result }}
        run: |
          # skip if no bark config
          if [ -z "$BARK_SERVER" ] || [ -z "$BARK_DEVICES" ]; then
            echo "no bark config, skipping notification"
            exit 0
          fi

          NOW=$(TZ="Asia/Shanghai" date "+%H:%M")

          if [ "$POKE_RESULT" = "success" ]; then
            TITLE="üêï quota ready @ $NOW"
            BODY="all accounts poked successfully"
          else
            TITLE="üêï poke failed @ $NOW"
            BODY="check workflow for details"
          fi

          # url encode
          TITLE_ENC=$(printf '%s' "$TITLE" | jq -sRr @uri)
          BODY_ENC=$(printf '%s' "$BODY" | jq -sRr @uri)

          # bark each device
          IFS=',' read -ra DEVICES <<< "$BARK_DEVICES"
          for device in "${DEVICES[@]}"; do
            device=$(echo "$device" | xargs)
            URL="${BARK_SERVER}/${device}/${TITLE_ENC}/${BODY_ENC}?group=quota&icon=https://claude.ai/favicon.ico"
            echo "barking to device..."
            curl -s "$URL" || echo "bark failed"
          done

          echo "woof!"
