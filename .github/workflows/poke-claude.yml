# the claude poking machine
# runs 3x daily to annoy claude into resetting quota

name: poke claude

on:
  schedule:
    # asia/shanghai times (UTC+8) - adjusted for GitHub's ~2hr delays
    # target 09:00 CST â†’ trigger 07:00 CST (23:00 UTC prev day)
    # target 14:00 CST â†’ trigger 13:30 CST (05:30 UTC)
    # target 19:00 CST â†’ trigger 18:45 CST (10:45 UTC)
    - cron: "0 23 * * *"
    - cron: "30 5 * * *"
    - cron: "45 10 * * *"

  workflow_dispatch:
    inputs:
      victim:
        description: "who to poke"
        required: false
        default: "everyone"
        type: choice
        options:
          - everyone
          - max5x
          - pro
      dry_run:
        description: "pretend to poke (for testing)"
        required: false
        default: false
        type: boolean
      bark:
        description: "send bark notification"
        required: false
        default: true
        type: boolean

jobs:
  poke:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - victim: max5x
            name: "the fancy one"
            poke_style: "draw tiny spaceship ascii (4 lines max, include pew pew). end with one unhinged roast."
          - victim: pro
            name: "the regular one"
            poke_style: "draw tiny stretching cat ascii (4 lines max). end with one savage roast."

    name: poking ${{ matrix.name }}

    steps:
      - name: should we poke this one?
        id: check
        run: |
          TARGET="${{ inputs.victim || 'everyone' }}"
          CURRENT="${{ matrix.victim }}"
          if [ "$TARGET" = "everyone" ] || [ "$TARGET" = "$CURRENT" ]; then
            echo "poke=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ $CURRENT is getting poked"
          else
            echo "poke=false" >> $GITHUB_OUTPUT
            echo "ðŸ˜´ $CURRENT gets to sleep"
          fi

      - name: poke poke poke
        id: poke
        if: steps.check.outputs.poke == 'true'
        uses: thevibeworks/claude-quota-scheduler@v1
        with:
          account_name: ${{ matrix.victim }}
          oauth_token: ${{ secrets[format('CLAUDE_OAUTH_{0}', matrix.victim)] }}
          timezone: "Asia/Shanghai"
          ping_prompt: ${{ matrix.poke_style }}
          dry_run: ${{ inputs.dry_run || 'false' }}
          summary_style: "ascii-art"

      - name: bark this one
        if: steps.check.outputs.poke == 'true' && (inputs.bark != false)
        env:
          BARK_SERVER: ${{ secrets.BARK_SERVER }}
          BARK_KEY: ${{ secrets.BARK_KEY }}
          BARK_MSG: ${{ steps.poke.outputs.bark_message }}
          VICTIM: ${{ matrix.victim }}
          SUCCESS: ${{ steps.poke.outputs.success }}
        run: |
          if [ -z "$BARK_SERVER" ] || [ -z "$BARK_KEY" ]; then
            echo "no bark config (need BARK_SERVER and BARK_KEY secrets)"
            exit 0
          fi

          # install barkme.sh with retry
          curl -fsSL https://raw.githubusercontent.com/thevibeworks/yolo-tools/main/src/bin/barkme.sh -o /tmp/barkme.sh
          chmod +x /tmp/barkme.sh

          NOW=$(TZ="Asia/Shanghai" date "+%H:%M")
          BODY="${BARK_MSG:-woke up}"

          if [ "$SUCCESS" = "true" ]; then
            /tmp/barkme.sh -R 3 -t "$VICTIM @ $NOW" -g "quota" -i "https://claude.ai/favicon.ico" "$BODY" || true
          else
            /tmp/barkme.sh -R 3 -t "$VICTIM ded @ $NOW" -g "quota" -l "timeSensitive" "$BODY" || true
          fi

  # each account barks for itself now with claude-generated messages
  # this job just shows overall status in the workflow UI
  status:
    needs: poke
    if: always()
    runs-on: ubuntu-latest
    name: "${{ needs.poke.result == 'success' && 'âœ“ all poked' || 'âœ— something failed' }}"
    steps:
      - run: |
          echo ""
          echo "  /\\_/\\"
          echo " ( o.o )  poke session complete"
          echo "  > ^ <"
          echo ""
          echo "result: ${{ needs.poke.result }}"
